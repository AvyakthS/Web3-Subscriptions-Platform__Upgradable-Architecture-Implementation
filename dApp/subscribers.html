<!-- subscribers.html (user subscriptions + plan lookup, all via Firestore) -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>For Plan Subscribers — Web3 Subscriptions Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <style>
        :root { --bg:#0b0f17; --card:#111727; --muted:#93a1b1; --text:#e8eef7; --accent:#7c5cff; --border:#263044; }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:#0b0f17; min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
        header{ display:flex; align-items:center; justify-content:space-between; padding:14px 20px; border-bottom:1px solid var(--border); background:rgba(9,12,22,.5); position:sticky; top:0; backdrop-filter:blur(6px); }
        .brand{ font-weight:700; }
        .right{ display:flex; gap:10px; align-items:center; }
        button{ cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid var(--border); color:var(--text); background:#0f1523; }
        main{ padding:24px; max-width:1200px; margin:0 auto; width:100%; }
        h2{ margin:10px 0 16px; }
        .layout{ display:grid; grid-template-columns: 1fr 380px; gap:16px; }
        .panel{ border:1px solid var(--border); background:linear-gradient(180deg, rgba(17,23,39,.7), rgba(12,16,27,.6)); border-radius:12px; padding:14px; }
        .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
        .box{ border:1px solid #2a3552; border-radius:10px; background:#0e1422; padding:10px; }
        .label{ color:#aab3cc; font-size:12px; margin-bottom:6px; }
        .value{ font-size:14px; }
        .search{ display:grid; gap:10px; }
        input, select{ background:#0e1422; color:var(--text); border:1px solid #2a3552; border-radius:10px; padding:10px 12px; }
        .primary{ background:linear-gradient(180deg, #8e75ff, #6b4bff); border:0; padding:10px 14px; border-radius:10px; color:var(--text); text-align:center; text-decoration:none; display:inline-block; }
        .footnote{ text-align:center; color:var(--muted); font-size:13px; line-height:1.25rem; padding:14px 12px 26px; }
        a{ color:inherit; text-decoration:none; }
    </style>
</head>
<body>
<header>
    <div class="brand">Web3 Subscriptions Platform</div>
    <div class="right">
        <button id="walletBtn">Connect Your MetaMask Wallet</button>
        <button id="googleBtn">Sign in with your Google Account</button>
        <div id="googleChip" style="display:none; gap:6px; align-items:center;">
            <div id="googleAvatar" style="width:28px;height:28px;border-radius:50%;background:#2b3650;display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:#c7d2fe;border:1px solid #3b4666;">G</div>
            <span id="googleName" style="font-size:14px; color:#dbe4ff;"></span>
        </div>
    </div>
</header>

<main>
    <div class="layout">
        <div class="panel">
            <h2>Your Subscriptions</h2>
            <div id="subsList" class="grid"></div>
        </div>
        <div class="panel">
            <div class="search">
                <label>Search by Plan Address</label>
                <input id="planAddr" placeholder="0x...">
                <button class="primary" id="lookup">Lookup Plan</button>
                <div id="planDetail" style="margin-top:8px;"></div>
                <a class="primary" id="createBtn" href="create-subscription.html" style="margin-top:8px;">Create A New Subscription</a>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="footnote">
        "Created by Avyakth S.<br>This is a hobby project.<br>Contact me at avyakth1000@gmail.com to provide feedback."
    </div>
</footer>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDYQmS0_qmZvTI8kt2lk7hwjVn2XZumkpU",
        authDomain: "web3-subscriptions-platform.firebaseapp.com",
        projectId: "web3-subscriptions-platform",
        storageBucket: "web3-subscriptions-platform.firebasestorage.app",
        messagingSenderId: "958526009151",
        appId: "1:958526009151:web:924c316a438abc5cdc6d8a",
        measurementId: "G-P6H1T71N0N"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();

    function short(a){ return a?a.slice(0,6)+'…'+a.slice(-4):''; }
    function isWallet(){ return localStorage.getItem('walletConnected')==='1'; }
    function fmtTs(ts){ if(!ts) return '-'; const d = (ts.toDate ? ts.toDate() : new Date(ts*1000)); return d.toLocaleString(); }

    async function connectWallet(){
        try{
            if(window.ethereum?.request){
                const acc = await window.ethereum.request({method:'eth_requestAccounts'});
                localStorage.setItem('walletAddress', acc[0]); localStorage.setItem('walletConnected','1');
            }
        }catch(e){}
        if(!isWallet()){
            const addr = prompt('Enter a wallet address (demo fallback):');
            if(addr?.startsWith('0x')){ localStorage.setItem('walletAddress', addr); localStorage.setItem('walletConnected','1'); }
        }
        updateTopbar();
    }
    async function googleSignIn(){ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ alert('Sign-in failed.'); } }
    function updateTopbar(){
        const wal = localStorage.getItem('walletAddress'); const wConn = isWallet(); const u = auth.currentUser;
        const walletBtn = document.getElementById('walletBtn'); const googleBtn = document.getElementById('googleBtn');
        const chip = document.getElementById('googleChip'); const nameEl = document.getElementById('googleName'); const avatar = document.getElementById('googleAvatar');
        if(wConn&&wal){ walletBtn.textContent=short(wal); walletBtn.disabled=true; } else { walletBtn.textContent='Connect Your MetaMask Wallet'; walletBtn.disabled=false; }
        if(u){ googleBtn.style.display='none'; chip.style.display='inline-flex'; const name=u.displayName||'GUser'; nameEl.textContent=name; if(u.photoURL){ avatar.style.background=`url(${u.photoURL}) center/cover no-repeat`; avatar.textContent=''; } else { avatar.style.background='#2b3650'; avatar.textContent=name.slice(0,1).toUpperCase(); } }
        else { googleBtn.style.display='inline-block'; chip.style.display='none'; }
    }
    document.getElementById('walletBtn').onclick = connectWallet;
    document.getElementById('googleBtn').onclick = googleSignIn;

    auth.onAuthStateChanged(async (user)=>{
        if(!user || !isWallet()){ window.location.href='index.html'; return; }
        updateTopbar();
        renderSubs(user.uid);
    });

    async function renderSubs(uid){
        const list = document.getElementById('subsList');
        list.innerHTML = '<div class="box"><div class="value" style="color:#aab3cc;">Loading…</div></div>';
        const snap = await db.collection('users').doc(uid).collection('subscriptions').get();
        if(snap.empty){
            list.innerHTML = '<div class="box"><div class="value" style="color:#aab3cc;">No subscriptions yet.</div></div>';
            return;
        }
        list.innerHTML = '';
        snap.forEach(doc=>{
            const s = doc.data();
            const bx = document.createElement('div');
            bx.className='box';
            bx.innerHTML = `
          <div class="label">Subscription Plan's ID (Address)</div><div class="value">${s.planAddress}</div>
          <div style="height:8px"></div>
          <div class="label">Subscription's Transaction Hash</div><div class="value">${s.txHash}</div>
          <div style="height:8px"></div>
          <div class="label">Subscription's Timestamp of Creation</div><div class="value">${fmtTs(s.createdAt)}</div>
          <div style="height:8px"></div>
          <div class="label">Subscription's Recurring Cost</div><div class="value">${s.cost} ${s.costUnit||'POL'}</div>
          <div style="height:8px"></div>
          <div class="label">Subscription's Duration</div><div class="value">${s.durationValue} ${s.durationUnit}</div>
        `;
            list.appendChild(bx);
        });
    }

    document.getElementById('lookup').addEventListener('click', async ()=>{
        const addr = (document.getElementById('planAddr').value||'').trim();
        const el = document.getElementById('planDetail');
        el.innerHTML = '';
        if(!addr){ el.innerHTML = '<div class="box">Enter a plan address.</div>'; return; }
        const doc = await db.collection('plans').doc(addr).get();
        if(!doc.exists){ el.innerHTML = '<div class="box">Plan not found.</div>'; return; }
        const p = doc.data();
        el.innerHTML = `
        <div class="box"><div class="label">Plan's ID (Address)</div><div class="value">${p.address}</div></div>
        <div class="box"><div class="label">Plan's Creation Transaction Hash</div><div class="value">${p.txHash}</div></div>
        <div class="box"><div class="label">Plan's Creation Timestamp</div><div class="value">${fmtTs(p.createdAt)}</div></div>
        <div class="box"><div class="label">Plan's Recurring Cost</div><div class="value">${p.cost} ${p.costUnit||'POL'}</div></div>
        <div class="box"><div class="label">Plan's Duration</div><div class="value">${p.durationValue} ${p.durationUnit}</div></div>
        <div class="box"><div class="label">Plan's Total Current Subscribers</div><div class="value">${p.currentSubs||0}</div></div>
        <div class="box"><div class="label">Plan's Total Lifetime Subscibers</div><div class="value">${p.lifetimeSubs||0}</div></div>
      `;
        document.getElementById('createBtn').href = `create-subscription.html?address=${encodeURIComponent(addr)}`;
    });
</script>
</body>
</html>
