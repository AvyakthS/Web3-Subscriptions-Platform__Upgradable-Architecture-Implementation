<!-- create-subscription.html (complete) -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Create Subscription — Web3 Subscriptions Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <!-- Requires Firebase SDK scripts (app-compat, auth-compat, firestore-compat) loaded globally before this file -->

    <style>
        :root { --bg:#0b0f17; --card:#111727; --muted:#93a1b1; --text:#e8eef7; --accent:#7c5cff; --border:#263044; }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:#0b0f17; min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
        header{ display:flex; align-items:center; justify-content:space-between; padding:14px 20px; border-bottom:1px solid var(--border); background:rgba(9,12,22,.5); position:sticky; top:0; backdrop-filter:blur(6px); }
        .brand{ font-weight:700; }
        .right{ display:flex; gap:10px; align-items:center; }
        button{ cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid var(--border); color:var(--text); background:#0f1523; }
        main{ padding:24px; max-width:760px; margin:0 auto; width:100%; }
        h2{ margin:10px 0 16px; }
        form{ border:1px solid var(--border); background:linear-gradient(180deg, rgba(17,23,39,.7), rgba(12,16,27,.6)); border-radius:12px; padding:16px; display:grid; gap:12px; }
        .row{ display:grid; gap:8px; }
        label{ color:#aab3cc; font-size:13px; }
        input{ background:#0e1422; color:var(--text); border:1px solid #2a3552; border-radius:10px; padding:10px 12px; }
        .actions{ display:flex; justify-content:flex-end; gap:10px; }
        .primary{ background:linear-gradient(180deg, #8e75ff, #6b4bff); border:0; padding:10px 14px; border-radius:10px; color:var(--text); }
        .footnote{ text-align:center; color:var(--muted); font-size:13px; line-height:1.25rem; padding:14px 12px 26px; }
        .avatar { width:28px;height:28px;border-radius:50%;background:#2b3650;display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:#c7d2fe;border:1px solid #3b4666; }
    </style>
</head>
<body>
<header>
    <div class="brand">Web3 Subscriptions Platform</div>
    <div class="right">
        <button id="walletBtn">Connect Your MetaMask Wallet</button>
        <button id="googleBtn">Sign in with your Google Account</button>
        <div id="googleChip" style="display:none; gap:6px; align-items:center;">
            <div id="googleAvatar" class="avatar">G</div>
            <span id="googleName" style="font-size:14px; color:#dbe4ff;"></span>
        </div>
    </div>
</header>

<main>
    <h2>Create A New Subscription</h2>
    <form id="subForm">
        <div class="row">
            <label>Plan Address</label>
            <input id="planAddress" placeholder="0x..." />
        </div>
        <div class="row">
            <label>Subscriber Wallet (auto)</label>
            <input id="walletAddress" readonly />
        </div>
        <div class="actions">
            <button type="button" onclick="history.back()">Cancel</button>
            <button class="primary" type="submit">Subscribe</button>
        </div>
    </form>
</main>

<footer>
    <div class="footnote">
        "Created by Avyakth S.<br>This is a hobby project.<br>Contact me at avyakth1000@gmail.com to provide feedback."
    </div>
</footer>

<script>
    // -------- Firebase init (SDK must be loaded globally) --------
    const firebaseConfig = {
        apiKey: "AIzaSyDYQmS0_qmZvTI8kt2lk7hwjVn2XZumkpU",
        authDomain: "web3-subscriptions-platform.firebaseapp.com",
        projectId: "web3-subscriptions-platform",
        storageBucket: "web3-subscriptions-platform.firebasestorage.app",
        messagingSenderId: "958526009151",
        appId: "1:958526009151:web:924c316a438abc5cdc6d8a",
        measurementId: "G-P6H1T71N0N"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // -------- Utilities --------
    function short(a){ return a ? a.slice(0,6) + '…' + a.slice(-4) : ''; }
    function isWallet(){ return localStorage.getItem('walletConnected') === '1'; }
    function randHex(bytes=32){ const a=crypto.getRandomValues(new Uint8Array(bytes)); return '0x' + Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function qs(key){ return new URLSearchParams(location.search).get(key); }

    // -------- Top bar / gating --------
    async function connectWallet(){
        try{
            if(window.ethereum?.request){
                const acc = await window.ethereum.request({ method:'eth_requestAccounts' });
                localStorage.setItem('walletAddress', acc[0]);
                localStorage.setItem('walletConnected', '1');
            }
        }catch(e){}
        if(!isWallet()){
            const addr = prompt('Enter a wallet address (demo fallback):');
            if(addr?.startsWith('0x')){
                localStorage.setItem('walletAddress', addr);
                localStorage.setItem('walletConnected', '1');
            }
        }
        updateTopbar();
        document.getElementById('walletAddress').value = localStorage.getItem('walletAddress') || '';
    }
    async function googleSignIn(){
        try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        catch(e){ alert('Sign-in failed.'); }
    }
    function updateTopbar(){
        const wal = localStorage.getItem('walletAddress');
        const wConn = isWallet();
        const u = auth.currentUser;
        const walletBtn = document.getElementById('walletBtn');
        const googleBtn = document.getElementById('googleBtn');
        const chip = document.getElementById('googleChip');
        const nameEl = document.getElementById('googleName');
        const avatar = document.getElementById('googleAvatar');

        if(wConn && wal){ walletBtn.textContent = short(wal); walletBtn.disabled = true; }
        else { walletBtn.textContent = 'Connect Your MetaMask Wallet'; walletBtn.disabled = false; }

        if(u){
            googleBtn.style.display = 'none';
            chip.style.display = 'inline-flex';
            const name = u.displayName || 'GUser';
            nameEl.textContent = name;
            if(u.photoURL){ avatar.style.background = `url(${u.photoURL}) center/cover no-repeat`; avatar.textContent = ''; }
            else { avatar.style.background = '#2b3650'; avatar.textContent = name.slice(0,1).toUpperCase(); }
        }else{
            googleBtn.style.display = 'inline-block';
            chip.style.display = 'none';
        }
    }
    document.getElementById('walletBtn').onclick = connectWallet;
    document.getElementById('googleBtn').onclick = googleSignIn;

    // -------- Auth state + initial fill --------
    auth.onAuthStateChanged((user)=>{
        if(!user || !isWallet()){ window.location.href = 'index.html'; return; }
        updateTopbar();
        document.getElementById('walletAddress').value = localStorage.getItem('walletAddress') || '';
        const pre = qs('address');
        if(pre){
            const inp = document.getElementById('planAddress');
            inp.value = pre;
            inp.readOnly = true;
        }
    });

    // -------- Submit handler --------
    document.getElementById('subForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const user = auth.currentUser;
        if(!user){ alert('Not signed in'); return; }

        const walletAddress = localStorage.getItem('walletAddress');
        if(!walletAddress){ alert('Wallet not connected'); return; }

        const planAddress = (document.getElementById('planAddress').value || '').trim();
        if(!planAddress || !planAddress.startsWith('0x')){ alert('Enter a valid plan address'); return; }

        try{
            const planRef = db.collection('plans').doc(planAddress);
            const planSnap = await planRef.get();
            if(!planSnap.exists){ alert('Plan not found'); return; }
            const plan = planSnap.data();

            // Prevent duplicate subscription by same user
            const dup = await planRef.collection('subscribers').where('uid','==',user.uid).limit(1).get();
            if(!dup.empty){
                alert('Already subscribed to this plan.');
                window.location.href = 'subscribers.html';
                return;
            }

            const txHash = randHex(32);
            const batch = db.batch();

            const subRef = planRef.collection('subscribers').doc();
            const userSubRef = db.collection('users').doc(user.uid).collection('subscriptions').doc(subRef.id);
            const eventsRef = db.collection('events').doc();

            batch.set(subRef, {
                uid: user.uid,
                googleUsername: user.displayName || '',
                googleEmail: user.email || '',
                walletAddress,
                txHash,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'Subscribed'
            });

            batch.update(planRef, {
                currentSubs: firebase.firestore.FieldValue.increment(1),
                lifetimeSubs: firebase.firestore.FieldValue.increment(1)
            });

            // Denormalize plan fields for quick listing
            batch.set(userSubRef, {
                planAddress,
                txHash,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                cost: plan.cost,
                costUnit: plan.costUnit || 'POL',
                durationValue: plan.durationValue,
                durationUnit: plan.durationUnit
            });

            batch.set(eventsRef, {
                type: 'subscription_create',
                uid: user.uid,
                planAddress,
                txHash,
                walletAddress,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });

            await batch.commit();

            // Redirect to the plan detail for immediate visibility
            window.location.href = `plan.html?address=${encodeURIComponent(planAddress)}`;
        }catch(err){
            console.error(err);
            alert('Subscription failed. Please try again.');
        }
    });
</script>
</body>
</html>
