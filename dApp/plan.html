<!-- plan.html (plan details + live subscribers from Firestore) -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Plan Detail — Web3 Subscriptions Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <style>
        :root { --bg:#0b0f17; --card:#111727; --muted:#93a1b1; --text:#e8eef7; --accent:#7c5cff; --border:#263044; }
        *{ box-sizing:border-box; }
        body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:#0b0f17; min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; }
        header{ display:flex; align-items:center; justify-content:space-between; padding:14px 20px; border-bottom:1px solid var(--border); background:rgba(9,12,22,.5); position:sticky; top:0; backdrop-filter:blur(6px); }
        .brand{ font-weight:700; }
        .right{ display:flex; gap:10px; align-items:center; }
        button{ cursor:pointer; padding:8px 12px; border-radius:10px; border:1px solid var(--border); color:var(--text); background:#0f1523; }
        main{ padding:24px; max-width:1100px; margin:0 auto; width:100%; }
        h2{ margin:10px 0 16px; }
        .box{ border:1px solid var(--border); background:linear-gradient(180deg, rgba(17,23,39,.7), rgba(12,16,27,.6)); border-radius:12px; padding:14px; margin-bottom:14px; }
        .field{ padding:8px 10px; border:1px solid #2a3552; border-radius:10px; background:#0e1422; margin:8px 0; }
        .label{ color:#aab3cc; font-size:12px; margin-bottom:6px; }
        .value{ font-size:14px; }
        .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:14px; }
        .footnote{ text-align:center; color:var(--muted); font-size:13px; line-height:1.25rem; padding:14px 12px 26px; }
        a{ color:inherit; text-decoration:none; }
    </style>
</head>
<body>
<header>
    <div class="brand">Web3 Subscriptions Platform</div>
    <div class="right">
        <button id="walletBtn">Connect Your MetaMask Wallet</button>
        <button id="googleBtn">Sign in with your Google Account</button>
        <div id="googleChip" style="display:none; gap:6px; align-items:center;">
            <div id="googleAvatar" style="width:28px;height:28px;border-radius:50%;background:#2b3650;display:inline-flex;align-items:center;justify-content:center;font-size:12px;color:#c7d2fe;border:1px solid #3b4666;">G</div>
            <span id="googleName" style="font-size:14px; color:#dbe4ff;"></span>
        </div>
    </div>
</header>

<main>
    <h2>Plan Overview</h2>
    <div id="planBox" class="box"></div>

    <h2>Subscribers</h2>
    <div id="subs" class="grid"></div>
</main>

<footer>
    <div class="footnote">
        "Created by Avyakth S.<br>This is a hobby project.<br>Contact me at avyakth1000@gmail.com to provide feedback."
    </div>
</footer>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDYQmS0_qmZvTI8kt2lk7hwjVn2XZumkpU",
        authDomain: "web3-subscriptions-platform.firebaseapp.com",
        projectId: "web3-subscriptions-platform",
        storageBucket: "web3-subscriptions-platform.firebasestorage.app",
        messagingSenderId: "958526009151",
        appId: "1:958526009151:web:924c316a438abc5cdc6d8a",
        measurementId: "G-P6H1T71N0N"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();

    function short(a){ return a?a.slice(0,6)+'…'+a.slice(-4):''; }
    function isWallet(){ return localStorage.getItem('walletConnected')==='1'; }
    function fmtTs(ts){ if(!ts) return '-'; const d = (ts.toDate ? ts.toDate() : new Date(ts*1000)); return d.toLocaleString(); }
    function qs(key){ return new URLSearchParams(location.search).get(key); }

    async function connectWallet(){
        try{
            if(window.ethereum?.request){
                const acc = await window.ethereum.request({method:'eth_requestAccounts'});
                localStorage.setItem('walletAddress', acc[0]); localStorage.setItem('walletConnected','1');
            }
        }catch(e){}
        if(!isWallet()){
            const addr = prompt('Enter a wallet address (demo fallback):');
            if(addr?.startsWith('0x')){ localStorage.setItem('walletAddress', addr); localStorage.setItem('walletConnected','1'); }
        }
        updateTopbar();
    }
    async function googleSignIn(){ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ alert('Sign-in failed.'); } }
    function updateTopbar(){
        const wal = localStorage.getItem('walletAddress'); const wConn = isWallet(); const u = auth.currentUser;
        const walletBtn = document.getElementById('walletBtn'); const googleBtn = document.getElementById('googleBtn');
        const chip = document.getElementById('googleChip'); const nameEl = document.getElementById('googleName'); const avatar = document.getElementById('googleAvatar');
        if(wConn&&wal){ walletBtn.textContent=short(wal); walletBtn.disabled=true; } else { walletBtn.textContent='Connect Your MetaMask Wallet'; walletBtn.disabled=false; }
        if(u){ googleBtn.style.display='none'; chip.style.display='inline-flex'; const name=u.displayName||'GUser'; nameEl.textContent=name; if(u.photoURL){ avatar.style.background=`url(${u.photoURL}) center/cover no-repeat`; avatar.textContent=''; } else { avatar.style.background='#2b3650'; avatar.textContent=name.slice(0,1).toUpperCase(); } }
        else { googleBtn.style.display='inline-block'; chip.style.display='none'; }
    }
    document.getElementById('walletBtn').onclick = connectWallet;
    document.getElementById('googleBtn').onclick = googleSignIn;

    let unsubPlan = null, unsubSubs = null;
    auth.onAuthStateChanged(async (user)=>{
        if(!user || !isWallet()){ window.location.href='index.html'; return; }
        updateTopbar();
        const address = qs('address');
        if(!address){ document.getElementById('planBox').innerHTML = '<div class="value" style="color:#aab3cc;">No plan address provided.</div>'; return; }

        const planRef = db.collection('plans').doc(address);
        unsubPlan = planRef.onSnapshot(snap=>{
            const planBox = document.getElementById('planBox');
            if(!snap.exists){ planBox.innerHTML = '<div class="value" style="color:#aab3cc;">Plan not found.</div>'; return; }
            const p = snap.data();
            planBox.innerHTML = `
          <div class="field"><div class="label">Plan's ID (Address)</div><div class="value">${p.address}</div></div>
          <div class="field"><div class="label">Plan's Creation Transaction Hash</div><div class="value">${p.txHash}</div></div>
          <div class="field"><div class="label">Plan's Creation Timestamp</div><div class="value">${fmtTs(p.createdAt)}</div></div>
          <div class="field"><div class="label">Plan's Recurring Cost</div><div class="value">${p.cost} ${p.costUnit||'POL'}</div></div>
          <div class="field"><div class="label">Plan's Duration</div><div class="value">${p.durationValue} ${p.durationUnit}</div></div>
          <div class="field"><div class="label">Plan's Total Current Subscribers</div><div class="value">${p.currentSubs||0}</div></div>
          <div class="field"><div class="label">Plan's Total Lifetime Subscibers</div><div class="value">${p.lifetimeSubs||0}</div></div>
        `;
        });

        const subsEl = document.getElementById('subs');
        unsubSubs = planRef.collection('subscribers').orderBy('createdAt','desc').onSnapshot(s=>{
            subsEl.innerHTML = '';
            if(s.empty){
                const empty = document.createElement('div');
                empty.className='box';
                empty.innerHTML = '<div class="value" style="color:#aab3cc;">No subscribers yet.</div>';
                subsEl.appendChild(empty);
                return;
            }
            s.forEach(doc=>{
                const x = doc.data();
                const box = document.createElement('div');
                box.className='box';
                box.innerHTML = `
            <div class="field"><div class="label">Subscriber's Google Username</div><div class="value">${x.googleUsername||'-'}</div></div>
            <div class="field"><div class="label">Subscriber's Email Address</div><div class="value">${x.googleEmail||'-'}</div></div>
            <div class="field"><div class="label">Subscriber's MetaMask Wallet Address</div><div class="value">${x.walletAddress||'-'}</div></div>
            <div class="field"><div class="label">Subscription Transaction Hash</div><div class="value">${x.txHash||'-'}</div></div>
            <div class="field"><div class="label">Subscription Creation Timestamp</div><div class="value">${fmtTs(x.createdAt)||'-'}</div></div>
            <div class="field"><div class="label">Subscription Status</div><div class="value">${x.status||'Subscribed'}</div></div>
          `;
                subsEl.appendChild(box);
            });
        });
    });

    window.addEventListener('beforeunload', ()=>{ if(unsubPlan) unsubPlan(); if(unsubSubs) unsubSubs(); });
</script>
</body>
</html>
